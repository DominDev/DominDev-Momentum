let botData=null;const SPLIT_REGEX=/[\s,.;!?]+/;const normalize=(str)=>str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");async function loadBotData(){if(botData)return botData;try{const response=await fetch("data/chatbot-db.json");const data=await response.json();data.normalizedVulgarWords=data.vulgarWords.map(normalize);data.precomputedGlossary=Object.keys(data.glossary).map((term)=>({original:term,normalized:normalize(term),}));data.normalizedKeywordMap={};data.precomputedPhrases=[];for(const key in data.keywordMap){const normalizedKey=normalize(key);data.normalizedKeywordMap[normalizedKey]=data.keywordMap[key];if(key.includes(" ")){data.precomputedPhrases.push({original:key,normalized:normalizedKey,});}}botData=data;return botData;}catch(error){console.error("Failed to load chatbot data:",error);return null;}}export function initChat(){const chatbotTrigger=document.getElementById("chatbot-trigger");const chatbotWindow=document.getElementById("chatbot-window");const chatbotClose=document.getElementById("chatbot-close");const chatbotInput=document.getElementById("chatbot-input");const chatbotSend=document.getElementById("chatbot-send");const chatbotMessages=document.getElementById("chatbot-messages");async function openChat(){chatbotWindow.classList.add("active");chatbotTrigger.classList.add("active");setTimeout(()=>{chatbotInput.focus();},100);if(!botData){await loadBotData();}}function closeChat(){chatbotWindow.classList.remove("active");chatbotTrigger.classList.remove("active");}if(chatbotTrigger){let touchStarted=false;const toggleChat=()=>{if(chatbotWindow.classList.contains("active")){closeChat();}else{openChat();}};const handleToggle=(e)=>{e.preventDefault();if(e.type==='touchend'){touchStarted=true;toggleChat();setTimeout(()=>{touchStarted=false;},400);}else if(e.type==='click'&&!touchStarted){toggleChat();}};chatbotTrigger.addEventListener("touchend",handleToggle,{passive:false});chatbotTrigger.addEventListener("click",handleToggle);}if(chatbotClose)chatbotClose.addEventListener("click",closeChat);document.addEventListener("keydown",(e)=>{if(e.key==="Escape"&&chatbotWindow.classList.contains("active")){closeChat();}});let lastMessageTime=0;const COOLDOWN_MS=500;function sendMessage(){const now=Date.now();if(now-lastMessageTime<COOLDOWN_MS)return;lastMessageTime=now;const msg=chatbotInput.value.trim();if(!msg)return;addMessage(msg,true);chatbotInput.value="";chatbotSend.classList.remove("active");if(!botData){addMessage("System initializing...",false);loadBotData().then(()=>{const response=getBotResponse(msg);addMessage(response);});}else{showTyping();setTimeout(()=>{removeTyping();const response=getBotResponse(msg);addMessage(response);},600+Math.random()*500);}}if(chatbotSend)chatbotSend.addEventListener("click",sendMessage);if(chatbotInput){chatbotInput.addEventListener("keypress",(e)=>{if(e.key==="Enter")sendMessage();});chatbotInput.addEventListener("input",()=>{if(chatbotInput.value.trim().length>0){chatbotSend.classList.add("active");}else{chatbotSend.classList.remove("active");}});}function addMessage(text,isUser=false){const div=document.createElement("div");div.className=`chat-message ${isUser?"user":"bot"}`;const messageContent=document.createElement("div");messageContent.className="message-content";if(isUser){messageContent.textContent=text;}else{(No innerHTML vulnerability)renderSafeHTML(messageContent,text);}div.appendChild(messageContent);chatbotMessages.appendChild(div);chatbotMessages.scrollTop=chatbotMessages.scrollHeight;if(!isUser&&window.innerWidth<=1024){const links=div.querySelectorAll("a");links.forEach((link)=>{link.addEventListener("click",()=>{closeChat();});});}}function renderSafeHTML(container,htmlString){container.textContent="";const parser=new DOMParser();const doc=parser.parseFromString(htmlString,"text/html");(lowercase convention)const allowedTags=["p","ul","ol","li","strong","b","a","br"];function sanitizeNode(node){if(node.nodeType===Node.TEXT_NODE){return document.createTextNode(node.textContent);}if(node.nodeType===Node.ELEMENT_NODE){const tagName=node.tagName.toLowerCase();if(allowedTags.includes(tagName)){const el=document.createElement(tagName);if(tagName==="a"){const href=node.getAttribute("href");if(href&&(href.startsWith("http")||href.startsWith("mailto")||href.startsWith("#")||href.startsWith("/"))){el.setAttribute("href",href.trim());}if(node.classList.contains("chatbot-link")){el.classList.add("chatbot-link");}if(href&&href.startsWith("http")){el.setAttribute("target","_blank");el.setAttribute("rel","noopener noreferrer");}}node.childNodes.forEach(child=>{const processedChild=sanitizeNode(child);if(processedChild)el.appendChild(processedChild);});return el;}else{(lub przetwÃ³rz dzieci bez wrappera)const fragment=document.createDocumentFragment();node.childNodes.forEach(child=>{const processedChild=sanitizeNode(child);if(processedChild)fragment.appendChild(processedChild);});return fragment;}}return null;}doc.body.childNodes.forEach(node=>{const sanitized=sanitizeNode(node);if(sanitized)container.appendChild(sanitized);});}function showTyping(){const div=document.createElement("div");div.className="chat-message bot";div.id="typing-indicator";const indicator=document.createElement("div");indicator.className="typing-indicator";indicator.appendChild(document.createElement("span"));indicator.appendChild(document.createElement("span"));indicator.appendChild(document.createElement("span"));div.appendChild(indicator);chatbotMessages.appendChild(div);chatbotMessages.scrollTop=chatbotMessages.scrollHeight;}function removeTyping(){const typing=document.getElementById("typing-indicator");if(typing)typing.remove();}function getBotResponse(msg){if(!botData)return "âš ï¸ System niedostÄ™pny. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.";if(!msg||msg.trim()===""){return "ðŸ¤” Nie rozumiem. Napisz coÅ›!";}const lowerInput=msg.toLowerCase().trim();const normalizedInput=normalize(lowerInput);let intent="unknown";if(botData.normalizedVulgarWords.some((word)=>normalizedInput.includes(word))){intent="vulgar";}(glossary)else{const glossaryMatch=botData.precomputedGlossary.find((term)=>normalizedInput.includes(term.normalized));if(glossaryMatch){return botData.glossary[glossaryMatch.original];}}if(intent==="unknown"){const phraseMatch=botData.precomputedPhrases.find((phrase)=>normalizedInput.includes(phrase.normalized));if(phraseMatch){intent=botData.keywordMap[phraseMatch.original];}}if(intent==="unknown"){const words=normalizedInput.split(SPLIT_REGEX);for(const word of words){(1)do znormalizowanej mapy if(botData.normalizedKeywordMap[word]){intent=botData.normalizedKeywordMap[word];break;}}}return getRandom(botData.responses[intent]);}function getRandom(arr){return Array.isArray(arr)?arr[Math.floor(Math.random()*arr.length)]:arr;}return{open:openChat,close:closeChat};}